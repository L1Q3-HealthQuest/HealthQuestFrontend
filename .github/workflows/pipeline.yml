name: HQF CI/CD Pipeline

on:
    pull_request:
            branches:
                - main

jobs:
    test:
        runs-on: ubuntu-latest
        outputs:
          unity-version: ${{ steps.unity-setup.outputs.unity-version }}
        steps:
          - name: Checkout repository
            uses: actions/checkout@v2
          - name: Set up Unity
            id: unity-setup
            uses: RageAgainstThePixel/unity-setup@v1.0.13
            with:
              unity-version: auto

          - name: Test Unity project
            run: |
              xvfb-run --auto-servernum --server-args='-screen 0 2560x1440x24' \
              /opt/unity/Editor/Unity \
              -projectPath . \
              -runTests \
              -testPlatform PlayMode

    build_android:
        runs-on: ubuntu-latest
        needs: test
        steps:
          - name: Checkout repository
            uses: actions/checkout@v2
          - name: Set up Unity
            uses: RageAgainstThePixel/unity-setup@v1.0.13
            with:
              unity-version: ${{ needs.test.outputs.unity-version }}
          - name: Build Android
            run: |
              xvfb-run --auto-servernum --server-args='-screen 0 2560x1440x24' \
              /opt/unity/Editor/Unity \
              -projectPath . \
              -buildTarget Android \
              -executeMethod BuildScript.BuildAndroid \
              -quit

    build_ios:
        runs-on: macos-latest
        needs: test
        steps:
          - name: Checkout repository
            uses: actions/checkout@v2
          - name: Set up Unity
            uses: RageAgainstThePixel/unity-setup@v1.0.13
            with:
              unity-version: ${{ needs.test.outputs.unity-version }}
          - name: Build iOS
            run: |
              /Applications/Unity/Hub/Editor/${{ needs.test.outputs.unity-version }}/Unity.app/Contents/MacOS/Unity \
              -projectPath . \
              -buildTarget iOS \
              -executeMethod BuildScript.BuildiOS \
              -quit